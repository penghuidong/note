# Linux文件系统



## 1. 设备文件

* 设备文件与系统的某个设备相对应
* 每种设备类型都有设备驱动程序处理I/O请求
* 每个设备驱动程序提供的接口一致
  * 隐藏了每个设备在操作方面的差异
* 设备的两种类型
  * 字符型设备：基于字符处理数据，如终端和键盘
  * 块设备：每次处理一块数据，如磁盘
*  设备文件通常位于/dev下



## 2. 文件系统

### 2. 1 文件系统结构

* 文件系统中空间分配的基本单位是逻辑块（1K,2K,4K）

* 文件系统的组成部分

  * 引导块：用于引导操作系统
  * 超级块：文件系统的信息，如i节点表容量，逻辑块大小，文件系统的大小
  * i节点表：每个文件或目录都在i节点中有一条记录
  * 数据块

   图： 描述文件系统结构

### 2.2 i节点



```c
struct super_block {
    struct list_head    s_list;     /* Keep this first */
 	dev_t           	s_dev;      /* search index; _not_ kdev_t */
    unsigned char 		s_blocksize_bits;
 	unsigned long       s_blocksize;
	loff_t          s_maxbytes; /* Max file size */
	struct file_system_type *s_type;
	const struct super_operations   *s_op;
	const struct dquot_operations   *dq_op;
	const struct quotactl_ops   *s_qcop;
	const struct export_operations *s_export_op;
	unsigned long       s_flags;
	unsigned long       s_iflags;   /* internal SB_I_* flags */
	unsigned long       s_magic;
	struct dentry       *s_root;
	struct rw_semaphore s_umount;
	int         s_count;
	atomic_t        s_active;  
    #ifdef CONFIG_SECURITY
	void                    *s_security;
	#endif
	const struct xattr_handler **s_xattr;
    
    struct hlist_bl_head    s_anon;     /* anonymous dentries for (nfs) exporting */
	struct list_head    s_mounts;   /* list of mounts; _not_ for fs use */
	struct block_device *s_bdev;
	struct backing_dev_info *s_bdi;
	struct mtd_info     *s_mtd;
	struct hlist_node   s_instances;
    unsigned int        s_quota_types;  /* Bitmask of supported quota types */
    struct quota_info   s_dquot;    /* Diskquota specific options */

    struct sb_writers   s_writers;

    char s_id[32];              /* Informational name */
    u8 s_uuid[16];              /* UUID */                                           
    void            *s_fs_info; /* Filesystem private info */
    unsigned int        s_max_links;
    fmode_t         s_mode; 
	/* Granularity of c/m/atime in ns.
		Cannot be worse than a second */
	u32        s_time_gran;
    /*
    * The next field is for VFS *only*. No filesystems have any business
    * even looking at it. You had been warned.
    */
    struct mutex s_vfs_rename_mutex;    /* Kludge */

    /*
     * Filesystem subtype.  If non-empty the filesystem type field
     * in /proc/mounts will be "type.subtype"
    */
    char *s_subtype;
                                             
    /*
    * Saved mount options for lazy filesystems using
    * generic_show_options()
    */
    char __rcu *s_options;
    const struct dentry_operations *s_d_op; /* default d_op for dentries */
    /*
    * Saved pool identifier for cleancache (-1 means none)
    */
	int cleancache_poolid;
	struct shrinker s_shrink;   /* per-sb shrinker handle */
	/* Number of inodes with nlink == 0 but still referenced */
	atomic_long_t s_remove_count;                                                                                                             
    /* Being remounted read-only */
	int s_readonly_remount;	
    /* AIO completions deferred from interrupt context */
	struct workqueue_struct *s_dio_done_wq;
   	struct hlist_head s_pins; 
	/*
	* Context in which to interpret filesystem uids, gids,
	* quotas, device nodes, extended attributes and security
	* labels.
	*/
	struct user_namespace *s_user_ns;
	/*
	* Keep the lru lists last in the structure so they always sit on their 
	* own individual cachelines.
	*/
	struct list_lru     s_dentry_lru ____cacheline_aligned_in_smp;
	struct list_lru     s_inode_lru ____cacheline_aligned_in_smp;
    struct rcu_head     rcu;
	struct work_struct  destroy_work;                                                     
	struct mutex        s_sync_lock;    /* sync serialisation lock */
    /*
	* Indicates how deep in a filesystem stack this SB is
	*/
	int s_stack_depth; 
	/* s_inode_list_lock protects s_inodes */
	spinlock_t      s_inode_list_lock ____cacheline_aligned_in_smp;	
    struct list_head    s_inodes;   /* all inodes */
};
    
```
